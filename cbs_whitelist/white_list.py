'''
Created on Nov 14, 2020

@author: Forrest Li
'''


from sqlalchemy import create_engine
import pymysql
import pandas as pd
import chinastock as cs
#import cbs_score_urlopen as cscore
import cbs_score as cscore
import time
db_connection_str = 'mysql+pymysql://root:A1234567@localhost/ms_financials_db'
db_connection = create_engine(db_connection_str)

pd.set_option("display.max_rows", None, "display.max_columns", None)

ticker_df = pd.read_sql(
         """
         SELECT * FROM ms_financials_db.morningstar_key_eps_percent where 3_year_average>20 and 5_year_average>18 and 10_year_average>15 and period in ('2019-12-31','2020-03-31','2020-06-30','2020-09-30')
         order by 3_year_average desc
         """
         , con=db_connection)

white_list=(ticker_df['ticker'].tolist())
#time.sleep(60)
cbs_d={}
#cbs_ch_d={'XHKG:02233': 'NAN', '000048': ['23.16', '33.14'], 'XHKG:00613': 'NAN', '600570': ['21.16', '56.91'], '300122': ['41.66', '69.49'], '600031': ['23.93', '35.12'], '600764': ['47.9', '66.7'], 'XHKG:00119': 'NAN', '600516': ['33.94', '81.85'], 'XHKG:00743': 'NAN', '600587': ['22.79', '21.55'], '600745': ['23.86', '34.79'], '300016': ['35.97', '73.97'], '005670': 'NAN', '300308': ['37.01', '37.58'], '002161': ['30.07', '21.92'], 'XHKG:00124': 'NAN', '601100': ['30.38', '52.41'], '000672': ['28.5', '58.15'], '600801': ['35.39', '51.68'], '000885': ['41.62', '41.83'], '300107': ['52.47', '75.52'], '000830': ['22.65', '47.49'], '000567': [], '300276': ['25.36', '20.35'], '601003': ['21.36', '59.57'], '000779': ['33.13', '73.13'], '300132': ['45.81', '67.9'], '002611': ['42.79', '49.76'], '003960': 'NAN', '300205': ['31.64', '32.53'], '000961': ['13.99', '12.32'], '002016': ['33.95', '71.7'], '600673': ['15.1', '54.65'], '300123': ['18.56', '24.44'], 'XHKG:01918': 'NAN', '600215': ['15.36', '19.48'], '300226': ['27.69', '28.08'], '000025': ['41.21', '46.01'], '200025': 'NAN', '600753': ['45.58', '74.91'], '600781': ['66.63', '52.87'], '006580': 'NAN', '000560': ['37.08', '19.07'], '600282': ['26.16', '56.48'], '001390': 'NAN', '600731': ['25.5', '38.01'], '600702': ['31.84', '42.31'], '600853': ['18.45', '23.47'], '600456': ['24.22', '18.51'], '000789': ['44.15', '60.38'], '600782': ['28.45', '65.21'], '600768': ['44.52', '67.37'], '600728': ['35.42', '37.17'], '600287': ['36.43', '37.36'], 'XHKG:03347': 'NAN', '300347': ['61.82', '64.9'], '600328': ['24.89', '42.53'], '002299': ['47.35', '26.75'], '600160': ['41.09', '63.12'], '002097': ['21.39', '21.19'], '600250': ['33.3', '53.93'], '002182': ['38.98', '32.55'], '600810': ['31.29', '31.99'], '600985': ['47.8', '56.07'], '000736': ['26.86', '37.18'], '600260': ['29.08', '41.76'], '000705': ['37.03', '36.02'], '002190': ['47.1', '23.95'], '300012': ['60.36', '43.97'], '000795': ['42.87', '53.19'], '002135': ['16.19', '22.94'], '600512': ['39.56', '42.93'], '002214': ['35.66', '31.01'], '002189': ['30.45', '42.74'], '601225': ['39.04', '61.6'], '600295': ['22.91', '28.77'], '002632': ['53.6', '58.71'], '600368': ['24.01', '29.95'], '600585': ['60.92', '79.78', '93.27', '94.96', '94.23', '92.99', '94.27', '94.96', '95.91', '95.35', '94.23'], 'XHKG:00914': 'NAN', '300236': ['50.0', '51.88'], '002384': ['27.96', '30.85'], '000906': ['44.38', '43.21'], '000757': ['45.78', '48.67'], '002458': ['71.16', '17.3'], '000656': ['31.86', '27.17'], '002746': ['81.96', '45.75'], '600132': ['44.67', '67.15'], '002475': ['57.46', '52.46'], '002127': ['80.32', '83.12'], '300198': ['44.22', '31.08'], '000661': ['74.81', '74.61'], '000061': ['19.86', '18.25'], '600466': ['28.56', '27.27'], '300285': ['66.58', '60.75'], 'XHKG:00581': 'NAN', '600052': ['51.1', '39.34'], 'XHKG:02007': 'NAN', '600763': ['79.52', '89.5'], '600846': ['37.83', '34.97'], '002605': ['49.03', '45.62'], '600559': ['54.97', '58.16'], '002541': ['32.31', '29.71'], '002599': ['28.02', '43.79'], '003230': 'NAN', '002080': ['27.99', '31.06'], '002175': ['31.61', '14.67'], '002088': ['50.18', '68.45'], '002099': ['49.83', '57.01'], '600809': ['63.97', '64.01'], '003090': 'NAN', 'XHKG:02382': 'NAN', '002057': ['58.7', '69.33'], '601016': ['21.87', '21.96'], '002648': ['39.41', '65.58'], '002371': ['31.99', '27.72'], '002601': ['35.5', '62.81'], '601012': ['70.69', '71.27', '54.99', '74.49', '74.83', '68.96', '71.78', '74.49', '79.38', '76.62', '74.83'], '002438': ['30.26', '25.32'], '000682': ['44.5', '61.03'], '000951': ['26.76', '39.34'], '600567': ['28.96', '49.5'], '300232': ['65.25', '54.41'], '601058': ['31.69', '30.09'], '002645': ['48.98', '56.85'], '300316': ['59.66', '50.1'], '002332': ['40.49', '47.3'], '600426': ['45.6', '48.35'], '300014': ['53.77', '45.64'], 'XHKG:00512': 'NAN', '600277': ['32.42', '43.74'], 'XHKG:00535': 'NAN', 'XHKG:01813': 'NAN', '600486': ['54.24', '63.15'], 'XHKG:01169': 'NAN', '300200': ['56.88', '38.92'], '002461': ['29.95', '32.58'], '601888': ['85.28', '89.36'], '600436': ['80.02', '83.23'], '601677': ['45.34', '45.08'], '002402': ['60.34', '69.64'], '601588': ['24.99', '28.62'], 'XHKG:00588': 'NAN', 'XHKG:01600': 'NAN', '600668': ['53.7', '58.7'], '000596': ['61.41', '68.71'], '200596': 'NAN', '600325': ['25.71', '21.93'], '000537': ['30.11', '35.02'], '000858': ['79.34', '83.35', '85.32', '85.99', '88.15', '87.29', '90.6', '85.99', '88.12', '88.33', '88.15'], 'XHKG:00189': 'NAN', '300003': ['64.23', '57.53'], '002439': ['65.43', '69.0'], '600956': ['22.93', '28.07'], 'XHKG:00956': 'NAN', '300137': ['64.74', '76.57'], '600519': ['88.47', '92.81', '93.62', '80.41', '84.69', '96.79', '98.03', '80.41', '85.57', '82.16', '84.69'], '002600': ['32.53', '59.04'], '300038': ['39.96', '56.68'], '300184': ['38.12', '53.07'], '002602': ['63.5', '62.3'], '601318': [], 'XHKG:02318': 'NAN', '600491': ['21.32', '20.39'], 'XHKG:01098': 'NAN', '000636': ['23.61', '37.75'], '600452': ['58.09', '52.72'], '600507': ['55.06', '70.62'], '002507': ['78.79', '78.02'], '300088': ['48.27', '49.36'], '300015': ['77.21', '77.58'], '300059': [], '000756': ['32.64', '42.06'], 'XHKG:00719': 'NAN', '300357': ['89.9', '88.82'], '600161': ['43.62', '88.83'], '000568': ['83.07', '85.29'], '601601': [], 'XHKG:02601': 'NAN', '002110': ['67.63', '83.69'], '600309': ['48.9', '60.65'], '002373': ['63.26', '66.35'], 'XHKG:00881': 'NAN', '002511': ['57.81', '58.14'], '002714': ['65.28', '68.74', '31.49', '77.49', '82.17', '31.29', '52.5', '77.49', '85.26', '84.98', '82.17'], '002035': ['73.36', '71.48'], 'XHKG:00700': 'NAN', '002020': ['46.72', '52.38'], '002139': ['55.11', '59.23'], '300383': ['54.27', '38.32'], '002262': ['73.35', '77.53'], '002221': ['38.71', '47.8'], '600667': ['36.87', '40.2'], 'XHKG:01061': 'NAN', '600340': ['39.04', '35.91'], 'XHKG:00095': 'NAN', '600577': ['46.66', '54.32'], '600995': ['45.42', '49.26'], 'XHKG:02020': 'NAN', 'XHKG:00384': 'NAN', '300365': ['78.14', '72.77'], '300031': ['69.37', '61.13'], '601799': ['54.28', '53.95'], 'XHKG:00098': 'NAN', '600529': ['62.45', '60.84'], '600276': ['90.39', '87.75', '84.51', '93.19', '92.87', '90.27', '93.66', '93.19', '90.95', '93.1', '92.87'], '600438': ['52.06', '54.93'], '002637': ['44.16', '32.15'], '300021': ['42.48', '37.58'], '600064': ['36.17', '34.9'], '600872': ['62.23', '62.92'], 'XHKG:00240': 'NAN', '601233': ['49.59', '53.53'], '002587': ['69.14', '59.87']}

for ticker in white_list:
#for k,v in cbs_ch_d.items():
    print(ticker)
    if 'XHKG' in ticker:
       ticker = ticker[5:]
    try:
       cs_score=cscore.get_cbs_score(ticker)
       print(cs_score)
       if(cs_score==[]):
           time.sleep(300)
       else:
           time.sleep(60)
       cbs_d[ticker] = cs_score
    except (RuntimeError, TypeError, NameError,AttributeError,ConnectionError) as E:
       print(E)    
    
print(cbs_d)
#{'XHKG:02233': 'NAN', '000048': ['23.16', '33.14'], 'XHKG:00613': 'NAN', '600570': ['21.16', '56.91'], '300122': ['41.66', '69.49'], '600031': ['23.93', '35.12'], '600764': ['47.9', '66.7'], 'XHKG:00119': 'NAN', '600516': ['33.94', '81.85'], 'XHKG:00743': 'NAN', '600587': ['22.79', '21.55'], '600745': ['23.86', '34.79'], '300016': ['35.97', '73.97'], '005670': 'NAN', '300308': ['37.01', '37.58'], '002161': ['30.07', '21.92'], 'XHKG:00124': 'NAN', '601100': ['30.38', '52.41'], '000672': ['28.5', '58.15'], '600801': ['35.39', '51.68'], '000885': ['41.62', '41.83'], '300107': ['52.47', '75.52'], '000830': ['22.65', '47.49'], '000567': [], '300276': ['25.36', '20.35'], '601003': ['21.36', '59.57'], '000779': ['33.13', '73.13'], '300132': ['45.81', '67.9'], '002611': ['42.79', '49.76'], '003960': 'NAN', '300205': ['31.64', '32.53'], '000961': ['13.99', '12.32'], '002016': ['33.95', '71.7'], '600673': ['15.1', '54.65'], '300123': ['18.56', '24.44'], 'XHKG:01918': 'NAN', '600215': ['15.36', '19.48'], '300226': ['27.69', '28.08'], '000025': ['41.21', '46.01'], '200025': 'NAN', '600753': ['45.58', '74.91'], '600781': ['66.63', '52.87'], '006580': 'NAN', '000560': ['37.08', '19.07'], '600282': ['26.16', '56.48'], '001390': 'NAN', '600731': ['25.5', '38.01'], '600702': ['31.84', '42.31'], '600853': ['18.45', '23.47'], '600456': ['24.22', '18.51'], '000789': ['44.15', '60.38'], '600782': ['28.45', '65.21'], '600768': ['44.52', '67.37'], '600728': ['35.42', '37.17'], '600287': ['36.43', '37.36'], 'XHKG:03347': 'NAN', '300347': ['61.82', '64.9'], '600328': ['24.89', '42.53'], '002299': ['47.35', '26.75'], '600160': ['41.09', '63.12'], '002097': ['21.39', '21.19'], '600250': ['33.3', '53.93'], '002182': ['38.98', '32.55'], '600810': ['31.29', '31.99'], '600985': ['47.8', '56.07'], '000736': ['26.86', '37.18'], '600260': ['29.08', '41.76'], '000705': ['37.03', '36.02'], '002190': ['47.1', '23.95'], '300012': ['60.36', '43.97'], '000795': ['42.87', '53.19'], '002135': ['16.19', '22.94'], '600512': ['39.56', '42.93'], '002214': ['35.66', '31.01'], '002189': ['30.45', '42.74'], '601225': ['39.04', '61.6'], '600295': ['22.91', '28.77'], '002632': ['53.6', '58.71'], '600368': ['24.01', '29.95'], '600585': ['60.92', '79.78', '93.27', '94.96', '94.23', '92.99', '94.27', '94.96', '95.91', '95.35', '94.23'], 'XHKG:00914': 'NAN', '300236': ['50.0', '51.88'], '002384': ['27.96', '30.85'], '000906': ['44.38', '43.21'], '000757': ['45.78', '48.67'], '002458': ['71.16', '17.3'], '000656': ['31.86', '27.17'], '002746': ['81.96', '45.75'], '600132': ['44.67', '67.15'], '002475': ['57.46', '52.46'], '002127': ['80.32', '83.12'], '300198': ['44.22', '31.08'], '000661': ['74.81', '74.61'], '000061': ['19.86', '18.25'], '600466': ['28.56', '27.27'], '300285': ['66.58', '60.75'], 'XHKG:00581': 'NAN', '600052': ['51.1', '39.34'], 'XHKG:02007': 'NAN', '600763': ['79.52', '89.5'], '600846': ['37.83', '34.97'], '002605': ['49.03', '45.62'], '600559': ['54.97', '58.16'], '002541': ['32.31', '29.71'], '002599': ['28.02', '43.79'], '003230': 'NAN', '002080': ['27.99', '31.06'], '002175': ['31.61', '14.67'], '002088': ['50.18', '68.45'], '002099': ['49.83', '57.01'], '600809': ['63.97', '64.01'], '003090': 'NAN', 'XHKG:02382': 'NAN', '002057': ['58.7', '69.33'], '601016': ['21.87', '21.96'], '002648': ['39.41', '65.58'], '002371': ['31.99', '27.72'], '002601': ['35.5', '62.81'], '601012': ['70.69', '71.27', '54.99', '74.49', '74.83', '68.96', '71.78', '74.49', '79.38', '76.62', '74.83'], '002438': ['30.26', '25.32'], '000682': ['44.5', '61.03'], '000951': ['26.76', '39.34'], '600567': ['28.96', '49.5'], '300232': ['65.25', '54.41'], '601058': ['31.69', '30.09'], '002645': ['48.98', '56.85'], '300316': ['59.66', '50.1'], '002332': ['40.49', '47.3'], '600426': ['45.6', '48.35'], '300014': ['53.77', '45.64'], 'XHKG:00512': 'NAN', '600277': ['32.42', '43.74'], 'XHKG:00535': 'NAN', 'XHKG:01813': 'NAN', '600486': ['54.24', '63.15'], 'XHKG:01169': 'NAN', '300200': ['56.88', '38.92'], '002461': ['29.95', '32.58'], '601888': ['85.28', '89.36'], '600436': ['80.02', '83.23'], '601677': ['45.34', '45.08'], '002402': ['60.34', '69.64'], '601588': ['24.99', '28.62'], 'XHKG:00588': 'NAN', 'XHKG:01600': 'NAN', '600668': ['53.7', '58.7'], '000596': ['61.41', '68.71'], '200596': 'NAN', '600325': ['25.71', '21.93'], '000537': ['30.11', '35.02'], '000858': ['79.34', '83.35', '85.32', '85.99', '88.15', '87.29', '90.6', '85.99', '88.12', '88.33', '88.15'], 'XHKG:00189': 'NAN', '300003': ['64.23', '57.53'], '002439': ['65.43', '69.0'], '600956': ['22.93', '28.07'], 'XHKG:00956': 'NAN', '300137': ['64.74', '76.57'], '600519': ['88.47', '92.81', '93.62', '80.41', '84.69', '96.79', '98.03', '80.41', '85.57', '82.16', '84.69'], '002600': ['32.53', '59.04'], '300038': ['39.96', '56.68'], '300184': ['38.12', '53.07'], '002602': ['63.5', '62.3'], '601318': [], 'XHKG:02318': 'NAN', '600491': ['21.32', '20.39'], 'XHKG:01098': 'NAN', '000636': ['23.61', '37.75'], '600452': ['58.09', '52.72'], '600507': ['55.06', '70.62'], '002507': ['78.79', '78.02'], '300088': ['48.27', '49.36'], '300015': ['77.21', '77.58'], '300059': [], '000756': ['32.64', '42.06'], 'XHKG:00719': 'NAN', '300357': ['89.9', '88.82'], '600161': ['43.62', '88.83'], '000568': ['83.07', '85.29'], '601601': [], 'XHKG:02601': 'NAN', '002110': ['67.63', '83.69'], '600309': ['48.9', '60.65'], '002373': ['63.26', '66.35'], 'XHKG:00881': 'NAN', '002511': ['57.81', '58.14'], '002714': ['65.28', '68.74', '31.49', '77.49', '82.17', '31.29', '52.5', '77.49', '85.26', '84.98', '82.17'], '002035': ['73.36', '71.48'], 'XHKG:00700': 'NAN', '002020': ['46.72', '52.38'], '002139': ['55.11', '59.23'], '300383': ['54.27', '38.32'], '002262': ['73.35', '77.53'], '002221': ['38.71', '47.8'], '600667': ['36.87', '40.2'], 'XHKG:01061': 'NAN', '600340': ['39.04', '35.91'], 'XHKG:00095': 'NAN', '600577': ['46.66', '54.32'], '600995': ['45.42', '49.26'], 'XHKG:02020': 'NAN', 'XHKG:00384': 'NAN', '300365': ['78.14', '72.77'], '300031': ['69.37', '61.13'], '601799': ['54.28', '53.95'], 'XHKG:00098': 'NAN', '600529': ['62.45', '60.84'], '600276': ['90.39', '87.75', '84.51', '93.19', '92.87', '90.27', '93.66', '93.19', '90.95', '93.1', '92.87'], '600438': ['52.06', '54.93'], '002637': ['44.16', '32.15'], '300021': ['42.48', '37.58'], '600064': ['36.17', '34.9'], '600872': ['62.23', '62.92'], 'XHKG:00240': 'NAN', '601233': ['49.59', '53.53'], '002587': ['69.14', '59.87']}
